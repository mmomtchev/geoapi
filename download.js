#!/usr/bin/env node
import{get}from"https";import{readFileSync,mkdirSync,createWriteStream}from"fs";import{parse,resolve}from"path";import{execFile}from"child_process";const config=JSON.parse(readFileSync("config.json"));mkdirSync(config.data_dir,{recursive:!0,mode:493});for(const conf of[config.geodb,config.altdb,...config.geojson]){const ext=parse(new URL(conf.src).pathname).ext;let outf=resolve(config.data_dir,conf.file);".zip"===ext.toLowerCase()&&(outf+=".zip");const file=createWriteStream(outf);console.log("downloading",conf.src),get(conf.src,(function(response){response.pipe(file)})),file.on("finish",(()=>{if(console.log("downloaded",outf),".zip"===ext.toLowerCase()){const zipCmd="win32"===process.platform?"powershell":"unzip",zipArgs="win32"===process.platform?["Expand-Archive",outf,"."]:["-ox",outf];execFile(zipCmd,zipArgs,{cwd:config.data_dir},((err,stdout,stderr)=>{err&&console.error("unzip failed",err,stderr)}))}}))}